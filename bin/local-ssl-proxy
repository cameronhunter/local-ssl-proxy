#!/usr/bin/env node

var fs = require("fs");
var kleur = require("kleur");
var proxy = require("http-proxy");
var commandline = require("../dist/commandline");

var args = commandline.parse();

var config = args.config || { proxy: args };

Object.keys(config).forEach(function (name) {
  var options = config[name];
  var hostname = options.hostname || args.hostname;
  var target = options.target || args.target;
  var key = options.key || args.key;
  var cert = options.cert || args.cert;
  var source = options.source || args.source;

  proxy
    .createServer({
      xfwd: true,
      ws: true,
      target: {
        host: hostname,
        port: target
      },
      ssl: {
        key: fs.readFileSync(key, "utf8"),
        cert: fs.readFileSync(cert, "utf8")
      }
    })
    .on("error", function (e) {
      console.error(kleur.red("Request failed to " + name + ": " + kleur.bold(e.code)));
    })
    .listen(source);

  console.log(kleur.green("Started " + kleur.bold(name) + ": https://" + hostname + ":" + source, "â†’ http://" + hostname + ":" + target));
});
